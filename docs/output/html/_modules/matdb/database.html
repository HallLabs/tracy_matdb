
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>matdb.database &#8212; matdb 0.0.5 documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">matdb 0.0.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for matdb.database</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Exposes classes and functions for interacting with the database</span>
<span class="sd">folders via a simple configuration file.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">makedirs</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">rename</span><span class="p">,</span> <span class="n">remove</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="k">import</span> <span class="n">uuid4</span>

<span class="kn">import</span> <span class="nn">ase.db</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">sha1</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">import_module</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">matdb</span> <span class="k">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">msg</span>
<span class="kn">from</span> <span class="nn">matdb.atoms</span> <span class="k">import</span> <span class="n">Atoms</span><span class="p">,</span> <span class="n">AtomsList</span><span class="p">,</span> <span class="n">_recursively_convert_units</span>
<span class="kn">from</span> <span class="nn">matdb.database.legacy</span> <span class="k">import</span> <span class="n">LegacyDatabase</span>
<span class="kn">from</span> <span class="nn">matdb.database.utility</span> <span class="k">import</span> <span class="n">parse_path</span><span class="p">,</span> <span class="n">split</span>
<span class="kn">from</span> <span class="nn">matdb.fitting.controller</span> <span class="k">import</span> <span class="n">TController</span>
<span class="kn">from</span> <span class="nn">matdb.io</span> <span class="k">import</span> <span class="n">read</span><span class="p">,</span> <span class="n">save_dict_to_h5</span>
<span class="kn">from</span> <span class="nn">matdb.msg</span> <span class="k">import</span> <span class="n">okay</span><span class="p">,</span> <span class="n">verbosity</span>
<span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="p">(</span><span class="n">chdir</span><span class="p">,</span> <span class="n">ParameterGrid</span><span class="p">,</span> <span class="n">convert_dict_to_str</span><span class="p">,</span>
                            <span class="n">import_fqdn</span><span class="p">,</span> <span class="n">is_uuid4</span><span class="p">,</span> <span class="n">_set_config_paths</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matdb</span> <span class="k">import</span> <span class="n">calculators</span>

<div class="viewcode-block" id="Group"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group">[docs]</a><span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a collection of material configurations (varying in</span>
<span class="sd">    structure and composition) from which a machine learning model can</span>
<span class="sd">    be created. Includes logic for generating the DFT directories that</span>
<span class="sd">    need to be run as well as extracting the relevant data from such</span>
<span class="sd">    computations.</span>

<span class="sd">    Args:</span>
<span class="sd">        execution (dict): key-value pairs of settings for the supercomputer job</span>
<span class="sd">          array batch file.</span>
<span class="sd">        root (str): full path to the root directory that this database will live</span>
<span class="sd">          in.</span>
<span class="sd">        parent (matdb.database.Database): the database that this</span>
<span class="sd">          group of calculations belongs to.</span>
<span class="sd">        prefix (str): sub-sampled configurations will be stored using integer</span>
<span class="sd">          ids after this prefix; for example `S.1`, `S.2`, etc.</span>
<span class="sd">        nconfigs (int): number of displaced configurations to create.</span>
<span class="sd">        config_type (str): the type of configuration.</span>
<span class="sd">        calculator (dict): a dictionary containing the information for</span>
<span class="sd">          the calculator object.</span>
<span class="sd">        trainable (bool): True if the groups configs will be used for traning.</span>
<span class="sd">        pgrid (ParamaterGrid): The ParameterGrid for the database.</span>
<span class="sd">        seeds (list, str, matdb.atoms.Atoms): The location of the files that will be</span>
<span class="sd">          read into to make the atoms object or an atoms object.</span>
<span class="sd">        cls (subclass): the subclass of :class:`~matdb.database.Group`.</span>
<span class="sd">        transforms (dict): a dictionary of transformations to apply to the</span>
<span class="sd">          seeds of the database before calculations are performed. Format is</span>
<span class="sd">          {&quot;name&quot;: {&quot;args&quot;: dict of keyword args}}, where the &quot;name&quot; keyword</span>
<span class="sd">          is the fully qualified path to the function.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        atoms (matdb.atoms.Atoms): a single atomic configuration from</span>
<span class="sd">          which many others may be derived using MD, phonon</span>
<span class="sd">          displacements, etc.</span>
<span class="sd">        configs (dict): keys are integer identifiers for the particular</span>
<span class="sd">          configuration; values are paths (relative to the base atoms root</span>
<span class="sd">          directory) in which calculations are performed.</span>
<span class="sd">        root (str): full path to the root directory that this database will live</span>
<span class="sd">          in.</span>
<span class="sd">        database (matdb.database.Database): parent database to which this group belongs.</span>
<span class="sd">        prefix (str): sub-sampled configurations will be stored using integer</span>
<span class="sd">          ids after this prefix; for example `S.1`, `S.2`, etc.</span>
<span class="sd">        nconfigs (int): number of displaced configurations to create.</span>
<span class="sd">        pgrid (ParamaterGrid): The ParameterGrid for the database.</span>
<span class="sd">        grpargs (dict): default arguments to construct the new groups; will</span>
<span class="sd">          be overridden by any parameter grid specs.</span>
<span class="sd">        splittable (bool): when True, this Group can be split into training,</span>
<span class="sd">          holdout and super sets because its configs are independent; otherwise,</span>
<span class="sd">          the configs are kept together and used *only* in the training set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seeded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">splittable</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="n">pgrid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">nconfigs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calculator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">config_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">execution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1">#override=None,</span>
                 <span class="n">rec_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transforms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Database</span><span class="p">):</span>
            <span class="c1">#Because we allow the user to override the name of the group, we</span>
            <span class="c1">#have to expand our root to use that name over here. However, for</span>
            <span class="c1">#recursively nested groups, we use the root passed in because it</span>
            <span class="c1">#already includes the relevant suffixes, etc.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_index</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution</span> <span class="o">=</span> <span class="n">execution</span> <span class="k">if</span> <span class="n">execution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span> <span class="k">if</span> <span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trainable</span> <span class="o">=</span> <span class="n">trainable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_seed_listed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">seeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_seed_listed</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rec_bin</span> <span class="o">=</span> <span class="n">rec_bin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span> <span class="o">=</span> <span class="n">pgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span> <span class="o">=</span> <span class="n">seeds</span>
        <span class="sd">&quot;&quot;&quot;list, str, matdb.atoms.Atoms: The location of the files that will be</span>
<span class="sd">        read into to make the atoms object or an atoms object. This is the</span>
<span class="sd">        parameter that was passed as the seed for the group constructor; for</span>
<span class="sd">        recursive constructions, it starts as a list of seed patterns, which</span>
<span class="sd">        gets expanded into individual seeds, which may then be coupled to</span>
<span class="sd">        parameter grid specs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grpargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">nconfigs</span><span class="o">=</span><span class="n">nconfigs</span><span class="p">,</span>
                            <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span> <span class="n">execution</span><span class="o">=</span><span class="n">execution</span><span class="p">,</span>
                            <span class="n">config_type</span><span class="o">=</span><span class="n">config_type</span><span class="p">,</span> <span class="n">calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calcargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">calculator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">calculator</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">calculators</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nconfigs</span> <span class="o">=</span> <span class="n">nconfigs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_type</span> <span class="o">=</span> <span class="n">config_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nsuccess</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;int: number of configurations whose output files were successfully</span>
<span class="sd">        converted to XYZ format. Should be equal to :attr:`nconfigs` if the</span>
<span class="sd">        database is complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span>

        <span class="c1">#Try and load existing folders that match the prefix into the configs</span>
        <span class="c1">#list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rx_folder</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">\.\d+&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

        <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">getcwd</span>
        <span class="k">with</span> <span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)):</span>
                <span class="c1">#We aren&#39;t interested in files, or folders that just happen to match</span>
                <span class="c1">#the naming convention.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rx_folder</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">cid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s2">&quot;atoms.h5&quot;</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">cid</span><span class="p">],</span><span class="s2">&quot;atoms.h5&quot;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s2">&quot;pre_comp_atoms.h5&quot;</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">cid</span><span class="p">],</span><span class="s2">&quot;pre_comp_atoms.h5&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No config atoms available for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">cid</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_uuid.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">))):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_uuid.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_uuid.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)),</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">time_stamp</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time_stamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">uuids</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># TODO: This entire code chunk needs to be moved to a class</span>
        <span class="c1"># method. It doesn&#39;t run properly as part of the class setup</span>
        <span class="c1"># because not all of the objects it searches for have been</span>
        <span class="c1"># loaded yet.</span>
        
        <span class="c1"># self.override = override.copy() if override is not None else {}</span>
        <span class="c1"># if bool(override):</span>
        <span class="c1">#     for k,v in override:</span>
        <span class="c1">#         obj_ins = self.database.controller.find(k)</span>
        <span class="c1">#         if isinstance(obj_ins,Atoms):</span>
        <span class="c1">#             if &quot;calc&quot; in v:</span>
        <span class="c1">#                 if self.rec_bin is not None:</span>
        <span class="c1">#                     #construct the path for the object in the recycling bin</span>
        <span class="c1">#                     new_path = path.join(self.rec_bin.root,</span>
        <span class="c1">#                                          &quot;{}-atoms.h5&quot;.format(obj_ins.uuid))</span>
        <span class="c1">#                     obj_ins.write(new_path)</span>
        <span class="c1">#                     self.database.parent.uuids[obj_ins.uuid] = new_path</span>
        <span class="c1">#                     if path.isfile(path.join(obj_ins.calc.folder,&quot;atoms.h5&quot;)):</span>
        <span class="c1">#                         # from os import remove</span>
        <span class="c1">#                         remove(path.join(obj_ins.calc.folder,&quot;atoms.h5&quot;))</span>
        <span class="c1">#                     # Make a new uuid for the new atoms object</span>
        <span class="c1">#                     # and overwrite the uuid file.</span>
        <span class="c1">#                     obj_ins.uuid = str(uuid4())</span>
        <span class="c1">#                     obj_ins.time_stamp = str(datetime.now())</span>
        <span class="c1">#                     with open(path.join(</span>
        <span class="c1">#                             obj_ins.root,</span>
        <span class="c1">#                             &quot;{}_{}_uuid.txt&quot;.format(obj_ins._db_name,</span>
        <span class="c1">#                                                     obj_ins.prefix)),&quot;w+&quot;) as f:</span>
        <span class="c1">#                         f.write(&quot;{0} \n {1}&quot;.format(obj_ins.uuid,obj_ins.time_stamp))</span>
        <span class="c1">#                     self.database.parent.uuids[obj_ins.uuid] = obj_ins</span>

        <span class="c1">#                 lcargs = None</span>
        <span class="c1">#                 if &quot;name&quot; in v[&quot;calc&quot;]:</span>
        <span class="c1">#                     new_calc = getattr(calculators, v[&quot;calc&quot;][&quot;name&quot;])</span>
        <span class="c1">#                     if &quot;Tracy&quot; in v[&quot;calc&quot;][&quot;name&quot;]:</span>
        <span class="c1">#                         lcargs = self._tracy_setup(calcargs = v[&quot;calc&quot;][&quot;calcargs&quot;])</span>
        <span class="c1">#                 else:</span>
        <span class="c1">#                     new_calc = obj_ins.calc</span>

        <span class="c1">#                 if lcargs is None:</span>
        <span class="c1">#                     lcargs = self.calcargs.copy()</span>
        <span class="c1">#                     lcargs.update(v[&quot;calc&quot;][&quot;calcargs&quot;])</span>
        <span class="c1">#                     del lcargs[&quot;name&quot;]</span>

        <span class="c1">#                 calc = new_calc(atoms, obj_ins.calc.folder, obj_ins.calc.contr_dir,</span>
        <span class="c1">#                                 obj_ins.calc.ran_seed, **lcargs)</span>
        <span class="c1">#                 obj_ins.set_calculator(calc)</span>
        <span class="c1">#         elif path.isfile(obj_ins):</span>
        <span class="c1">#             #If the object is a file path then it&#39;s pointing</span>
        <span class="c1">#             #to an old instance of a class objcet that has</span>
        <span class="c1">#             #been saved to file.</span>
        <span class="c1">#             msg.warn(&quot;Can&#39;t update object, it has already been overwritten.&quot;)</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             args = obj_ins.to_dict()</span>
        <span class="c1">#             if self.rec_bin is not None:</span>
        <span class="c1">#                 for atm in self.fitting_configs():</span>
        <span class="c1">#                     # from os import rename</span>
        <span class="c1">#                     atms = Atoms(atm)</span>
        <span class="c1">#                     new_atm = path.join(selg.rec_bin.root,</span>
        <span class="c1">#                                         &quot;{}-atoms.h5&quot;.format(atms.uuid))</span>
        <span class="c1">#                     self.database.parent.uuids[atms.uuid] = new_atm</span>
        <span class="c1">#                     rename(atm,new_atm)</span>
        <span class="c1">#             obj_ins.save_pkl(obj_ins.to_dict(),&quot;{}.pkl&quot;.format(self.uuid))</span>
        <span class="c1">#             self.database.parent.uuids[obj_ins.uuid] = path.join(obj_ins.root,</span>
        <span class="c1">#                                                                  &quot;{}.pkl&quot;.format(</span>
        <span class="c1">#                                                                      self.uuid))</span>
        <span class="c1">#             args.update(v)</span>
        <span class="c1">#             obj_ins.__init__(**args)</span>
        <span class="c1">#             obj_ins.uuid = str(uuid4())</span>
        <span class="c1">#             obj_ins.time_stamp = str(datetime.now())</span>
        <span class="c1">#             with open(path.join(obj_ins.root,</span>
        <span class="c1">#                                 &quot;{}_{}_uuid.txt&quot;.format(obj_ins._db_name,</span>
        <span class="c1">#                                                         obj_ins.prefix)),&quot;w+&quot;) as f:</span>
        <span class="c1">#                 f.write(&quot;{0} \n {1}&quot;.format(obj_ins.uuid,obj_ins.time_stamp))</span>
        <span class="c1">#             self.database.parent.uuids[obj_ins.uuid] = obj_ins</span>
        <span class="c1">#             obj_ins.setup(rerun=1)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the directory name for the group (i.e.,</span>
<span class="sd">        :func:`os.path.basename`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calculator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a representative calculator for the group. This will be the calculator</span>
<span class="sd">        attached to one of the :attr:`config_atoms` in the expanded group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">calculator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">get_calculator</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iconfigs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides a generator over all the configurations in this group and its</span>
<span class="sd">        children.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">iconfigs</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">atoms</span>

    <span class="k">def</span> <span class="nf">_expand_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively expands the nested groups to populate :attr:`sequence`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_seeds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">seedname</span><span class="p">,</span> <span class="n">at_seed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">seed_root</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">seedname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">seed_root</span><span class="p">):</span>
                    <span class="n">mkdir</span><span class="p">(</span><span class="n">seed_root</span><span class="p">)</span>

                <span class="n">clsargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grpargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">clsargs</span><span class="p">[</span><span class="s2">&quot;pgrid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clsargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">clsargs</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_root</span>
                <span class="n">clsargs</span><span class="p">[</span><span class="s2">&quot;seeds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">at_seed</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at_seed</span><span class="p">,</span><span class="n">Atoms</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">at_seed</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#pragma: no cover</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">err</span><span class="p">(</span><span class="s2">&quot;The Group must have a class to have seeds.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">seedname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">clsargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span><span class="p">:</span>
                    <span class="n">this_root</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">pkey</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">this_root</span><span class="p">):</span>
                        <span class="n">mkdir</span><span class="p">(</span><span class="n">this_root</span><span class="p">)</span>

                    <span class="n">clsargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grpargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">clsargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgrid</span><span class="p">[</span><span class="n">pkey</span><span class="p">])</span>
                    <span class="n">clsargs</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_root</span>
                    <span class="n">clsargs</span><span class="p">[</span><span class="s2">&quot;seeds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">,</span><span class="n">Atoms</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#pragma: no cover</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">err</span><span class="p">(</span><span class="s2">&quot;The Group must have a class to have a parameter grid.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">pkey</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">clsargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span>

    <span class="k">def</span> <span class="nf">_expand_seeds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seeds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Expands explicitly listed seed wildcard patterns to populate the</span>
<span class="sd">        :attr:`seeds` dict.</span>
<span class="sd">        Args:</span>
<span class="sd">            seeds (list, str, matdb.atoms.Atoms): The location of the files that will be</span>
<span class="sd">              read into to make the atoms object or an atoms object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_seed_listed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">atomspec</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
                <span class="n">fmt</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">atomspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;POSCAR&quot;</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;vasp&quot;</span>
                <span class="k">for</span> <span class="n">apath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">relpaths</span><span class="p">([</span><span class="n">pattern</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">apath</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">apath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">seeds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">seeded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n_seeds</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">.</span><span class="n">rset</span><span class="p">):</span>
                <span class="n">seedname</span> <span class="o">=</span> <span class="s2">&quot;seed-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_seeds</span><span class="p">)</span>
                <span class="c1">#NB! The previous rset may be a dict with an &quot;atoms&quot; key and</span>
                <span class="c1">#additional keys to pass to the group constructor. We copy it to</span>
                <span class="c1">#make sure the original rset doesn&#39;t modify. For normal cases</span>
                <span class="c1">#where it is simply an Atoms object, the copy performs the same</span>
                <span class="c1">#function.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">seedname</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the parent :class:`~matdb.database.Database` instance for</span>
<span class="sd">        this group, irrespective of how deep it is in the recursive stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Database</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">database</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trainable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if the group configs should be used for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainable</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractproperty</span>
    <span class="k">def</span> <span class="nf">fitting_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a :class:`~matdb.atoms.AtomsList` for all configs in this group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span> <span class="c1">#pragma: no cover</span>

<div class="viewcode-block" id="Group.sub_dict"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.sub_dict">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">sub_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of the parameters passed in to create this</span>
<span class="sd">        group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span> <span class="c1">#pragma: no cover</span></div>

<div class="viewcode-block" id="Group.to_dict"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">include_time_stamp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of the parameters passed into the group instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from matdb import __version__</span>
        <span class="c1"># import sys</span>

        <span class="n">kw_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grpargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;root&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;override&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">,</span>
                     <span class="s2">&quot;version&quot;</span><span class="p">:</span><span class="n">__version__</span><span class="p">,</span> <span class="s2">&quot;python_version&quot;</span><span class="p">:</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">include_time_stamp</span><span class="p">:</span>
            <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">kw_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">in</span> <span class="n">kw_dict</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kw_dict</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span>

        <span class="n">kw_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">kw_dict</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rset_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the full path to the `rset.h5` file for this group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;rset.h5&quot;</span><span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractproperty</span>
    <span class="k">def</span> <span class="nf">rset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the rset for the group and all sequences of the group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span> <span class="c1">#pragma: no cover</span>

<div class="viewcode-block" id="Group.hash_group"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.hash_group">[docs]</a>    <span class="k">def</span> <span class="nf">hash_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hashes the rset and the parameters of the  for the group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from matdb.utility import convert_dict_to_str</span>
        <span class="n">hash_str</span> <span class="o">=</span> <span class="n">convert_dict_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">include_time_stamp</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rset</span><span class="p">:</span>
            <span class="n">temp_atom</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="n">hash_str</span> <span class="o">+=</span> <span class="n">convert_dict_to_str</span><span class="p">(</span><span class="n">temp_atom</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sha1</span><span class="p">(</span><span class="n">hash_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>

<div class="viewcode-block" id="Group.load_pkl"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.load_pkl">[docs]</a>    <span class="k">def</span> <span class="nf">load_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">rel_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads a pickled obj from the specified location on the path.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_name (str): the file name to be save too.</span>
<span class="sd">            rel_path (str): the relative path from self.root that the file will</span>
<span class="sd">              be saved to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span> \
                 <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_path</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Group.save_pkl"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.save_pkl">[docs]</a>    <span class="k">def</span> <span class="nf">save_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">rel_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the obj passed to the correct location on the path.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (dict): The dictionary to be written to file.</span>
<span class="sd">            file_name (str): the file name to be save too.</span>
<span class="sd">            rel_path (str): the relative path from self.root that the file will</span>
<span class="sd">              be saved to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span> \
                 <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_path</span><span class="p">,</span><span class="s2">&quot;wb+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Group.save_index"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.save_index">[docs]</a>    <span class="k">def</span> <span class="nf">save_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes the unique index for each of the configs to file along with</span>
<span class="sd">        the relative path to the atoms.json file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;index.json&quot;</span><span class="p">),</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">f</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads in the index from the index.json file if it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;index.json&quot;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;index.json&quot;</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the previous group in the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keylist</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">keylist</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the next, or dependent, group in the databes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keylist</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">i</span><span class="o">!=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keylist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">keylist</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>

<div class="viewcode-block" id="Group.is_executing"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.is_executing">[docs]</a>    <span class="k">def</span> <span class="nf">is_executing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the database DFT calculations are in process of being</span>
<span class="sd">        executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">is_executing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">is_executing</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">is_executing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">is_executing</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">executing</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">is_executing</span><span class="p">()</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">is_executing</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">executing</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">is_executing</span></div>

<div class="viewcode-block" id="Group.execute"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submits the job script for each of the folders in this</span>
<span class="sd">        database if they are ready to run.</span>

<span class="sd">        Args:</span>
<span class="sd">            dryrun (bool): when True, simulate the submission without actually submitting.</span>
<span class="sd">            recovery (bool): when True, submit the script for running recovery jobs.</span>
<span class="sd">            env_vars (dict): dict of environment variables to set before calling the execution. The variables will be set back after execution.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the submission generated a job id (considered successful).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">jobfile</span> <span class="o">=</span> <span class="s2">&quot;recovery.sh&quot;</span> <span class="k">if</span> <span class="n">recovery</span> <span class="k">else</span> <span class="s2">&quot;jobfile.sh&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">jobfile</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">can_execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                           <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1">#We also need to check that we haven&#39;t already submitted this</span>
                <span class="c1">#job. Check to see if it is executing.</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">is_executing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                       <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1">#Make sure that the calculation isn&#39;t complete.</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">can_extract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                       <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># We must have what we need to execute. Compile the command and</span>
            <span class="c1"># submit.</span>
            <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">execute</span>

            <span class="n">shell_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">shell_command</span>
            <span class="c1"># We suport &#39;bash&#39; and &#39;sbatch&#39; shell commands, if it&#39;s neighter one </span>
            <span class="c1"># of them, default to &#39;bash&#39; </span>
            <span class="k">if</span> <span class="n">shell_command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;sbatch&#39;</span><span class="p">]:</span>
                <span class="n">shell_command</span> <span class="o">=</span> <span class="s1">&#39;bash&#39;</span> 
            <span class="n">cargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">shell_command</span><span class="p">,</span> <span class="n">jobfile</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">matdb.msg</span> <span class="k">import</span> <span class="n">okay</span>
                <span class="n">okay</span><span class="p">(</span><span class="s2">&quot;Executed </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xres</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">cargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">env_vars</span><span class="o">=</span><span class="n">env_vars</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xres</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&quot;Submitted&quot;</span> <span class="ow">in</span> <span class="n">xres</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="kn">from</span> <span class="nn">matdb.msg</span> <span class="k">import</span> <span class="n">okay</span>
                <span class="n">okay</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">xres</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">already_executed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">already_executed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span>
                                                      <span class="n">recovery</span><span class="o">=</span><span class="n">recovery</span><span class="p">,</span>
                                                      <span class="n">env_vars</span><span class="o">=</span><span class="n">env_vars</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">already_executed</span><span class="p">)</span></div>

<div class="viewcode-block" id="Group.recover"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.recover">[docs]</a>    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compiles a list of all DFT runs that didn&#39;t complete and compiles the</span>
<span class="sd">        `failures` file. Creates a jobfile to re-run the failed</span>
<span class="sd">        folders only.</span>

<span class="sd">        Args:</span>
<span class="sd">            rerun (int): when &gt; 0, recreate the jobfile even if it</span>
<span class="sd">              already exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">detail</span><span class="p">[</span><span class="s2">&quot;done&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">]</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">|</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">xpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;failures&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#Only write a failures file if we had failures.</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failed</span><span class="p">))</span>

                <span class="n">imsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: queued </span><span class="si">{1:d}</span><span class="s2"> configs for recovery.&quot;</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">imsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">okay</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: no failures.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identity</span><span class="p">))</span>

            <span class="c1">#Only create a jobfile if there were actually failures</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobfile</span><span class="p">(</span><span class="n">rerun</span><span class="p">,</span> <span class="n">recovery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Delete any existing recovery files from previous failures.</span>
                <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">remove</span>
                <span class="n">jobfile</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;recovery.sh&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jobfile</span><span class="p">):</span>
                    <span class="n">remove</span><span class="p">(</span><span class="n">jobfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xpath</span><span class="p">):</span>
                    <span class="n">remove</span><span class="p">(</span><span class="n">xpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">group</span><span class="o">.</span><span class="n">recover</span><span class="p">(</span><span class="n">rerun</span><span class="o">=</span><span class="n">rerun</span><span class="p">)</span></div>

<div class="viewcode-block" id="Group.jobfile"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.jobfile">[docs]</a>    <span class="k">def</span> <span class="nf">jobfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the job array file to run each of the sub-configurations in</span>
<span class="sd">        this database.</span>

<span class="sd">        Args:</span>
<span class="sd">            rerun (int): when &gt; 0, recreate the jobfile even if it already exists.</span>
<span class="sd">            recovery (bool): when True, configure the jobfile to run recovery jobs for those that have previously failed. This uses a different template and execution path.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recovery</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">linecount</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;recovery.sh&quot;</span><span class="p">)</span>
                <span class="n">xpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;failures&quot;</span><span class="p">)</span>
                <span class="n">asize</span> <span class="o">=</span> <span class="n">linecount</span><span class="p">(</span><span class="n">xpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;jobfile.sh&quot;</span><span class="p">)</span>
                <span class="n">xpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
                <span class="n">asize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rerun</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">asize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># We use the global execution parameters and then any updates</span>
            <span class="c1"># locally. We need to add the execution directory (including prefix) and</span>
            <span class="c1"># the number of jobs in the array.</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;execution_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpath</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;array_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asize</span>

            <span class="k">if</span> <span class="s2">&quot;array_limit&quot;</span> <span class="ow">in</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">asize</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;array_limit&quot;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;array_limit&quot;</span><span class="p">]</span>

            <span class="kn">from</span> <span class="nn">jinja2</span> <span class="k">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">PackageLoader</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">PackageLoader</span><span class="p">(</span><span class="s1">&#39;matdb&#39;</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">recovery</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;recovery&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">])</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">group</span><span class="o">.</span><span class="n">jobfile</span><span class="p">(</span><span class="n">rerun</span><span class="o">=</span><span class="n">rerun</span><span class="p">,</span> <span class="n">recovery</span><span class="o">=</span><span class="n">recovery</span><span class="p">)</span></div>

    <span class="c1"># def _tracy_setup(self, calcargs=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Extracts the needed information from the group that needs to be</span>
    <span class="c1">#     passed to the Tracy calculator.</span>

    <span class="c1">#     Args:</span>
    <span class="c1">#         calcargs (dict): the updates to the global calculation arguments.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     calcinput = self.calcargs.copy()</span>
    <span class="c1">#     if calcargs is not None:</span>
    <span class="c1">#         calcinput.update(calcargs)</span>
    <span class="c1">#     del calcinput[&quot;name&quot;]</span>

    <span class="c1">#     tracy = {}</span>
    <span class="c1">#     exec_settings = self.Database.execution.copy()</span>
    <span class="c1">#     if self.prev is not None and self.seeded:</span>
    <span class="c1">#         tracy[&quot;group_preds&quot;] = self.prev.uuid</span>

    <span class="c1">#     if &quot;eCommerce&quot; in exec_settings:</span>
    <span class="c1">#         tracy[&quot;ecommerce&quot;] = exec_settings[&quot;eCommerce&quot;]</span>

    <span class="c1">#     if &quot;contract_predecessors&quot; in exec_settings:</span>
    <span class="c1">#         tracy[&quot;contract_preds&quot;] = exec_settings[&quot;contract_predecessors&quot;]</span>

    <span class="c1">#     if &quot;priority&quot; in exec_settings:</span>
    <span class="c1">#         tracy[&quot;contract_priority&quot;] = exec_settings[&quot;priority&quot;]</span>

    <span class="c1">#     keys = [&quot;time&quot;, &quot;flops&quot;, &quot;minimum_ram&quot;, &quot;minimum_mem&quot;, &quot;ncores&quot;, &quot;network_latency&quot;,</span>
    <span class="c1">#             &quot;role&quot;]</span>
    <span class="c1">#     for key in keys:</span>
    <span class="c1">#         if key not in exec_settings.keys():</span>
    <span class="c1">#             raise ValueError(&quot;{0} must be set by the user.&quot;)</span>

    <span class="c1">#     tracy[&quot;max_time&quot;] = int(exec_settings[&quot;time&quot;])*360</span>
    <span class="c1">#     tracy[&quot;min_flops&quot;] = int(exec_settings[&quot;flops&quot;])</span>
    <span class="c1">#     tracy[&quot;min_ram&quot;] = int(exec_settings[&quot;minimum_ram&quot;])</span>
    <span class="c1">#     tracy[&quot;min_mem&quot;] = int(exec_settings[&quot;minimum_mem&quot;])</span>
    <span class="c1">#     tracy[&quot;ncores&quot;] = int(exec_settings[&quot;ncores&quot;])</span>
    <span class="c1">#     tracy[&quot;max_net_lat&quot;] = int(exec_settings[&quot;network_latency&quot;])</span>
    <span class="c1">#     tracy[&quot;role&quot;] = exec_settings[&quot;role&quot;]</span>
    <span class="c1">#     if &quot;notifications&quot; in exec_settings:</span>
    <span class="c1">#         tracy[&quot;notifications&quot;] = exec_settings[&quot;notifications&quot;]</span>

    <span class="c1">#     return {&quot;calcargs&quot;: calcinput, &quot;tracy&quot;: tracy}</span>

<div class="viewcode-block" id="Group.create"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">cid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calcargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">extractable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Creates a folder within this group to calculate properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            atoms (matdb.atoms.Atoms): atomic configuration to run.</span>
<span class="sd">            cid (int): integer configuration id; if not specified, defaults to</span>
<span class="sd">              the next available integer.</span>
<span class="sd">            rewrite (bool): when True, overwrite any existing files with the</span>
<span class="sd">              latest settings.</span>
<span class="sd">            sort (bool): when True, sort the atoms by type so that</span>
<span class="sd">              supercell writes work correctly.</span>
<span class="sd">            calcargs (dict): additional config-specific arguments for the</span>
<span class="sd">              calculator that will be created and attached to the atoms object.</span>
<span class="sd">            extractable (bool): True if the creation needs to write files for</span>
<span class="sd">              later calculation and extraction. If False then we just write</span>
<span class="sd">              an atoms.h5 object for later use as a seed for another group.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: new integer configuration id if one was auto-assigned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">import_fqdn</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">mkdir</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">cid</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="n">mkdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s2">&quot;uuid.txt&quot;</span><span class="p">)):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s2">&quot;uuid.txt&quot;</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s2">&quot;uuid.txt&quot;</span><span class="p">),</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">time_stamp</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s2">&quot;atoms.h5&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">rewrite</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">rename</span>
                <span class="n">back_up_path</span> <span class="o">=</span> <span class="n">back_up_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.atoms.h5&#39;</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_bin</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-atoms.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
                <span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s1">&#39;atoms.h5&#39;</span><span class="p">),</span><span class="n">new_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">uuids</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_path</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>

            <span class="n">trans_atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">()</span>
            <span class="n">trans_atoms</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func_args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">modojb</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">import_fqdn</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">trans_atoms</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">trans_atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">func_args</span><span class="p">)</span>

            <span class="n">trans_atoms</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uid</span>
            <span class="n">trans_atoms</span><span class="o">.</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time_stamp</span>
            <span class="n">trans_atoms</span><span class="o">.</span><span class="n">group_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>
            <span class="k">if</span> <span class="s2">&quot;Tracy&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="c1">#pragma: no cover</span>
                <span class="n">lcargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracy_setup</span><span class="p">(</span><span class="n">calcargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lcargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">lcargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">calcargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lcargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">calcargs</span><span class="p">)</span>

            <span class="n">calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="n">trans_atoms</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ran_seed</span><span class="p">,</span> <span class="o">**</span><span class="n">lcargs</span><span class="p">)</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="n">trans_atoms</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span>
            <span class="c1"># Turns out we need this for some seedless configurations.</span>
            <span class="k">if</span> <span class="n">extractable</span><span class="p">:</span>
                <span class="n">trans_atoms</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s2">&quot;pre_comp_atoms.h5&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trans_atoms</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s2">&quot;atoms.h5&quot;</span><span class="p">))</span>
            <span class="c1">#Finally, store the configuration for this folder.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans_atoms</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">uuids</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans_atoms</span>
            <span class="k">return</span> <span class="n">cid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">group</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">cid</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="n">rewrite</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span></div>

<div class="viewcode-block" id="Group.ready"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.ready">[docs]</a>    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if this database has been completely initialized *and* has</span>
<span class="sd">        all its computations&#39; results ready.</span>

<span class="sd">        .. note:: This method should be overloaded by a sub-class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: this method is intended to be overloaded by a sub-class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Method `ready` must be overloaded by a &quot;</span>
                                  <span class="s2">&quot;sub-class.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Group.is_setup"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.is_setup">[docs]</a>    <span class="k">def</span> <span class="nf">is_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if all the necessary folders for sub-configurations of the seed</span>
<span class="sd">        atomic configuration exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#Test to see if we have already set the database up.</span>
            <span class="n">confok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nconfigs</span> <span class="ow">or</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nconfigs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">imsg</span> <span class="o">=</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> database has already been setup.&quot;</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">imsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">confok</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1">#Don&#39;t run setup if the program is currently executing.</span>
            <span class="n">xok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_executing</span><span class="p">():</span>
                <span class="n">xok</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">confok</span> <span class="ow">or</span> <span class="n">xok</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">already_setup</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">is_setup</span><span class="p">()</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">already_setup</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Group.setup"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_setup</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the setup of the database using the `db_setup` function</span>
<span class="sd">        passed in by the specific group instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            db_setup (function): a function that will perform the setup for each</span>
<span class="sd">                group independently.</span>
<span class="sd">            rerun (int): values &gt; 0 cause rerunning of the setup at different granularity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">.</span><span class="n">can_extract</span><span class="p">():</span>
            <span class="c1">#Before we attempt to setup the folders, we first need to construct</span>
            <span class="c1">#the recursive sequence groups. This cannot happen until the</span>
            <span class="c1">#previous group in the database is ready, which is why it happens</span>
            <span class="c1">#here rather than in __init__.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">rerun</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">db_setup</span><span class="p">(</span><span class="n">rerun</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;compute.pkl&quot;</span><span class="p">),</span><span class="s2">&quot;wb+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">},</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">rerun</span><span class="o">=</span><span class="n">rerun</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Group.status"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_msg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a status message for statistics of sub-configuration execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            print_msg (bool): when True, return a text message with aggregate status information; otherwise, return a dict of the numbers involved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">count_nonzero</span> <span class="k">as</span> <span class="n">cnz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">summaries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">subsummary</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">summaries</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsummary</span>

        <span class="n">allatoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">allconfigs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">allconfigs</span><span class="p">,</span><span class="n">allatoms</span><span class="p">):</span>
            <span class="n">ready</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">can_execute</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">done</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">can_extract</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">)</span>
        <span class="n">is_busy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_executing</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">summary</span> <span class="ow">in</span> <span class="n">summaries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ready</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupname</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">v</span>
                          <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;ready&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
            <span class="n">done</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupname</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">v</span>
                          <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;done&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
            <span class="n">N</span> <span class="o">+=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="s2">&quot;N&quot;</span><span class="p">]</span>
            <span class="n">is_busy</span> <span class="o">=</span> <span class="n">is_busy</span> <span class="ow">and</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;busy&quot;</span><span class="p">]</span>

        <span class="n">rdata</span><span class="p">,</span> <span class="n">ddata</span> <span class="o">=</span> <span class="n">cnz</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ready</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="n">cnz</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">done</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">rmsg</span> <span class="o">=</span> <span class="s2">&quot;ready to execute </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">dmsg</span> <span class="o">=</span> <span class="s2">&quot;finished executing </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ddata</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">busy</span> <span class="o">=</span> <span class="s2">&quot; busy executing...&quot;</span> <span class="k">if</span> <span class="n">is_busy</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">print_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmsg</span><span class="p">,</span> <span class="n">dmsg</span><span class="p">,</span> <span class="n">busy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ready&quot;</span><span class="p">:</span> <span class="n">ready</span><span class="p">,</span>
                <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="n">done</span><span class="p">,</span>
                <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;ready&quot;</span><span class="p">:</span> <span class="n">rdata</span><span class="p">,</span>
                    <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="n">ddata</span><span class="p">,</span>
                    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span>
                <span class="p">},</span>
                <span class="s2">&quot;busy&quot;</span><span class="p">:</span> <span class="n">is_busy</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Group.can_extract"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.can_extract">[docs]</a>    <span class="k">def</span> <span class="nf">can_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs post-execution routines to clean-up the calculations. This super class</span>
<span class="sd">        implementation only checks that each of the sub-config directories has</span>
<span class="sd">        the necessary files needed for extraction of output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nconfigs</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nconfigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1">#We need to have at least one folder for each config;</span>
                <span class="c1">#otherwise we aren&#39;t ready to go.</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">can_extract</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s2">&quot;Config </span><span class="si">{}</span><span class="s2"> not ready for extraction.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">can_extract</span><span class="p">()</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

<div class="viewcode-block" id="Group.tarball"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.tarball">[docs]</a>    <span class="k">def</span> <span class="nf">tarball</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;output.tar.gz&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a zipped tar archive that contains each of the specified</span>
<span class="sd">        files in sub-sampled configurations&#39; output folders.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): name of the zipped archive to create.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">tarball</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.*/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>

            <span class="n">targs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tar&quot;</span><span class="p">,</span> <span class="s2">&quot;-cvzf&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)]</span>
            <span class="c1"># from matdb.utility import execute</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">targs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">group</span><span class="o">.</span><span class="n">tarball</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Group.extract"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">asis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a hdf5 file for each atoms object in the group.</span>

<span class="sd">        Args:</span>
<span class="sd">            cleanup (str): the level of cleanup to perform after</span>
<span class="sd">              extraction.</span>
<span class="sd">            asis (bool): when True, read the results even if the calculation</span>
<span class="sd">              didn&#39;t converge to required accuracy.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_extract</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;atoms.h5&quot;</span><span class="p">)):</span>
                    <span class="c1">#We don&#39;t need to recreate the atoms objects if they already</span>
                    <span class="c1">#exist.</span>
                    <span class="k">continue</span>
                <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">remove</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_atoms</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
                <span class="c1">#We only write the atoms.h5 if extraction returns successful.</span>
                <span class="k">if</span> <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">,</span> <span class="n">asis</span><span class="o">=</span><span class="n">asis</span><span class="p">):</span>
                    <span class="n">atoms</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;atoms.h5&quot;</span><span class="p">))</span>
                    
                <span class="c1"># For debugging, we really don&#39;t want to remove these yet;</span>
                <span class="c1"># otherwise it is a *big pain* to recreate them.</span>
                <span class="c1"># if path.isfile(path.join(folder, &quot;pre_comp_atoms.h5&quot;)):</span>
                <span class="c1">#     remove(path.join(folder, &quot;pre_comp_atoms.h5&quot;))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_extract</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">,</span> <span class="n">asis</span><span class="o">=</span><span class="n">asis</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cleaned</span><span class="p">:</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rset</span>
                <span class="n">atoms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">uuid</span><span class="p">):</span> <span class="n">f</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">}</span>
                <span class="kn">from</span> <span class="nn">matdb.io</span> <span class="k">import</span> <span class="n">save_dict_to_h5</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;rset.h5&quot;</span><span class="p">),</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
                    <span class="n">save_dict_to_h5</span><span class="p">(</span><span class="n">hf</span><span class="p">,</span><span class="n">atoms_dict</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cleaned</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_extract</span><span class="p">()</span></div>

<div class="viewcode-block" id="Group.finalize"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Group.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of the uuid, hash, parameters, and the rset</span>
<span class="sd">        for the group.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">matdb.atoms</span> <span class="k">import</span> <span class="n">_recursively_convert_units</span>

        <span class="n">final_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_group</span><span class="p">()</span>
        <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>

        <span class="n">rset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rset</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">AtomsList</span><span class="p">(</span><span class="n">rset</span><span class="p">)</span>

        <span class="c1"># The rset exists for a set of parameters. We want to know</span>
        <span class="c1"># which sets of parameters went into making the rset.</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finalizing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atm</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="n">this_uuid</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">group_uuid</span>
            <span class="k">if</span> <span class="n">this_uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uuids</span><span class="p">:</span>
                <span class="c1"># We need to get the parameters for this instance of</span>
                <span class="c1"># the group and it&#39;s key to store the parameters under</span>
                <span class="n">uuids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_uuid</span><span class="p">)</span>
                <span class="n">group_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">this_uuid</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">group_inst</span><span class="o">.</span><span class="n">key</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">group_inst</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">include_time_stamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_inst</span><span class="o">.</span><span class="n">grpargs</span>
                <span class="n">params_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_recursively_convert_units</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_dict</span></div></div>

<span class="k">def</span> <span class="nf">_conform_atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">ekey</span><span class="p">,</span> <span class="n">fkey</span><span class="p">,</span> <span class="n">vkey</span><span class="p">,</span> <span class="n">hesskey</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Renames the parameters and properties in the specified atoms object to</span>
<span class="sd">    conform to the energy, force, virial and hessian fitting names.</span>

<span class="sd">    Args:</span>
<span class="sd">        atoms (matdb.Atoms): configuration to conform values to.</span>
<span class="sd">        ekey (str): existing energy parameter key name.</span>
<span class="sd">        fkey (str): existing force parameter key name.</span>
<span class="sd">        vkey (str): existing virial parameter key name.</span>
<span class="sd">        hesskey (str): existing hessian parameter key name.</span>

<span class="sd">    Returns:</span>

<span class="sd">    matdb.Atoms: new atoms object with the quantities renamed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#We need to rename the parameters and properties of the individual atoms</span>
    <span class="c1">#objects to match the refkey and global choice of &quot;ref_energy&quot;,</span>
    <span class="c1">#&quot;ref_force&quot; and &quot;ref_virial&quot;. *NB* for some of the fitting</span>
    <span class="c1">#configs (for example Hessian fitting), a config may only have</span>
    <span class="c1">#an eigenvalue/eigenvector pair and no energy, force or virial</span>
    <span class="c1">#information.</span>
    <span class="n">ati</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="s2">&quot;atoms.h5&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ekey</span> <span class="ow">in</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">ekey</span><span class="p">]</span>
        <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ref_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="k">del</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">ekey</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fkey</span> <span class="ow">in</span> <span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">fkey</span><span class="p">]</span>
        <span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;ref_force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">force</span>
        <span class="k">del</span> <span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">fkey</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">vkey</span> <span class="ow">in</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">virial</span> <span class="o">=</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">vkey</span><span class="p">]</span>
        <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ref_virial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">virial</span>
        <span class="k">del</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">vkey</span><span class="p">]</span>

    <span class="c1">#There may be many hessian parameters depending on whether</span>
    <span class="c1">#custom parameters are used per-eigenvalue.</span>
    <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">hesskey</span> <span class="ow">in</span> <span class="n">pname</span><span class="p">:</span>
            <span class="n">eigval</span> <span class="o">=</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
            <span class="n">repkey</span> <span class="o">=</span> <span class="n">pname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hesskey</span><span class="p">,</span> <span class="s2">&quot;ref_hessian&quot;</span><span class="p">)</span>
            <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">repkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigval</span>
            <span class="k">del</span> <span class="n">ati</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">hesskey</span> <span class="ow">in</span> <span class="n">pname</span><span class="p">:</span>
            <span class="n">eigvec</span> <span class="o">=</span> <span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
            <span class="n">repkey</span> <span class="o">=</span> <span class="n">pname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hesskey</span><span class="p">,</span> <span class="s2">&quot;ref_hessian&quot;</span><span class="p">)</span>
            <span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">repkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigvec</span>
            <span class="k">del</span> <span class="n">ati</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ati</span>

<div class="viewcode-block" id="Database"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database">[docs]</a><span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a Database of groups (all inheriting from :class:`~matdb.database.Group`) that</span>
<span class="sd">    are all related be the atomic configuration that they model.</span>

<span class="sd">    .. note:: See the list of attributes below which correspond to the sections</span>
<span class="sd">      in the YAML database specification file.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): name of the configuration that this database sequence is</span>
<span class="sd">          operating for.</span>
<span class="sd">        root (str): root directory in which all other database sequences for</span>
<span class="sd">          the configurations in the same specification will be stored.</span>
<span class="sd">        parent (Controller): instance controlling multiple configurations.</span>
<span class="sd">        steps (list): list of `dict` describing the kinds of sub-configuration</span>
<span class="sd">          database steps to setup.</span>
<span class="sd">        splits (dict): keys are split names; values are `float` *training*</span>
<span class="sd">          percentages to use.</span>
<span class="sd">        ran_seed (int): random seed to use for splits in this database.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        title (str): title for the alloy system that these databases work with.</span>
<span class="sd">        config (str): name of the configuration that this database sequence is</span>
<span class="sd">          running for.</span>
<span class="sd">        species (list): list of `str` element names in the alloy system.</span>
<span class="sd">        potcars (dict): keys are lower-case element names; values are *suffixes*</span>
<span class="sd">          for the various pseudo-potentials that ship with VASP.</span>
<span class="sd">        root (str): root directory in which all other database directories will</span>
<span class="sd">          be stored. Defaults to the current directory.</span>
<span class="sd">        plotdir (str): path to the directory to store plots in for this</span>
<span class="sd">          database. Defaults to the parent controller&#39;s plot directory.</span>
<span class="sd">        incar (dict): keys are valid settings in the INCAR file that should be</span>
<span class="sd">          used as defaults for *all* database calculations (with their</span>
<span class="sd">          corresponding values).</span>
<span class="sd">        kpoints (dict): keys are valid settings for the Mueller k-point PRECALC</span>
<span class="sd">          file that should be used as default for *all* database calculations.</span>
<span class="sd">        steps (OrderedDict): keys are step names (e.g. `dft`, `calibration`,</span>
<span class="sd">          etc.); values are the corresponding class instances.</span>
<span class="sd">        parent (Controller): instance controlling multiple configurations.</span>
<span class="sd">        rec_bin (RecycleBin): instance of the recycling bin database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">ran_seed</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">splits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">splits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran_seed</span> <span class="o">=</span> <span class="n">ran_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitroot</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;splits&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">makedirs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitroot</span><span class="p">):</span>
            <span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitroot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rec_bin</span> <span class="o">=</span> <span class="n">RecycleBin</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">splits</span><span class="p">)</span>

        <span class="n">parrefs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="s2">&quot;plotdir&quot;</span><span class="p">,</span> <span class="s2">&quot;calculator&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">parrefs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ref</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">steps</span>
        <span class="sd">&quot;&quot;&quot;dict: with keys and values describing the kinds of step databases to setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># from os import mkdir</span>
        <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">ParameterGrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dbspec</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbspec</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="c1">#This is a reference to an existing database instance that was</span>
                <span class="c1">#defined previously.</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">dbspec</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
                <span class="k">continue</span>

            <span class="n">modname</span><span class="p">,</span> <span class="n">clsname</span> <span class="o">=</span> <span class="n">dbspec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">fqdn</span> <span class="o">=</span> <span class="s2">&quot;matdb.database.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">fqdn</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">clsname</span><span class="p">):</span><span class="c1"># pragma: no cover</span>
                <span class="c1">#We haven&#39;t implemented this database type yet, just skip the</span>
                <span class="c1">#initialization for now.</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The </span><span class="si">{0}</span><span class="s2"> group has not been implemented yet.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clsname</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">clsname</span><span class="p">)</span>

            <span class="c1">#Make a copy of the original dictionary so that we don&#39;t mess up the</span>
            <span class="c1">#pointers; then add in the keyword arguments that are missing.</span>
            <span class="n">cpspec</span> <span class="o">=</span> <span class="n">dbspec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;pgrid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParameterGrid</span><span class="p">(</span><span class="n">cpspec</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cpspec</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="s2">&quot;suffix&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">cpspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;*&quot;</span> <span class="o">==</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">cpspec</span><span class="p">[</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">del</span> <span class="n">cpspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
            <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;rec_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_bin</span>
            <span class="c1">#Handle the special cases where settings are specified uniquely for</span>
            <span class="c1">#each of the configurations separately.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cpspec</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cpspec</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">in</span> <span class="n">cpspec</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">cpspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpspec</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">]</span>

            <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">cpspec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_uuid.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_uuid.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_uuid.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)),</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">time_stamp</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time_stamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">uuids</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

<div class="viewcode-block" id="Database.hash_db"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.hash_db">[docs]</a>    <span class="k">def</span> <span class="nf">hash_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the hash for the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hashes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">hashes</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
            <span class="n">hashes</span> <span class="o">+=</span> <span class="n">step</span><span class="o">.</span><span class="n">hash_group</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sha1</span><span class="p">(</span><span class="n">hashes</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iconfigs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a generator over all the configurations in all sub-steps of</span>
<span class="sd">        this database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isteps</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">isteps</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a generator over steps in this sequence. The generator yields</span>
<span class="sd">        the next step *only* if the previous one is already finished (i.e., the</span>
<span class="sd">        `ready()` method returns True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">previous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                <span class="n">previous</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">previous</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

<div class="viewcode-block" id="Database.recover"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.recover">[docs]</a>    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs recovery on this database to determine which configs failed and</span>
<span class="sd">        then create a jobfile to requeue them for compute.</span>

<span class="sd">        Args:</span>
<span class="sd">            rerun (int): when &gt; 0, recreate the jobfile even if it already exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">db</span><span class="o">.</span><span class="n">recover</span><span class="p">(</span><span class="n">rerun</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.status"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">busy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints a status message for each of the databases relative</span>
<span class="sd">        to VASP execution status.</span>

<span class="sd">        Args:</span>
<span class="sd">            busy (bool): when True, print a list of the configurations that are still busy being computed in DFT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matdb.msg</span> <span class="k">import</span> <span class="n">verbosity</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isteps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">busy</span><span class="p">:</span>
                <span class="n">busy2</span> <span class="o">=</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
                <span class="n">imsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> =&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">busy2</span><span class="p">))</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">imsg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">detail</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">running</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">detail</span><span class="p">[</span><span class="s2">&quot;done&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">running</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="n">msg</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.execute"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submits job array files for any of the databases that are ready to</span>
<span class="sd">        execute, but which haven&#39;t been submitted yet.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (bool): when True, submit the script for running recovery</span>
<span class="sd">              jobs.</span>
<span class="sd">            env_vars (dict): dict of environment variables to set before calling the</span>
<span class="sd">              execution. The variables will be set back after execution.</span>
<span class="sd">            dryrun (bool): when True, don&#39;t submit any jobs for execution, just</span>
<span class="sd">              say what would happen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isteps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ready</span><span class="p">:</span>
                <span class="n">ready</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span> <span class="ow">or</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">recovery</span><span class="o">=</span><span class="n">recovery</span><span class="p">,</span>
                                                  <span class="n">env_vars</span><span class="o">=</span><span class="n">env_vars</span><span class="p">,</span>
                                                  <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>
                <span class="n">imsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Group </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> is not ready to execute yet, or is &quot;</span>
                        <span class="s2">&quot;already executing. Done.&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">imsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dbname</span><span class="p">))</span>
                <span class="k">break</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">blank</span><span class="p">()</span></div>

<div class="viewcode-block" id="Database.train_file"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.train_file">[docs]</a>    <span class="k">def</span> <span class="nf">train_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the full path to the h5 database file that can be</span>
<span class="sd">        used for training.</span>

<span class="sd">        Args:</span>
<span class="sd">            split (str): name of the split to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitroot</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-train.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">))</span></div>

<div class="viewcode-block" id="Database.holdout_file"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.holdout_file">[docs]</a>    <span class="k">def</span> <span class="nf">holdout_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the full path to the h5 database file that can be</span>
<span class="sd">        used to validate the potential fit.</span>

<span class="sd">        Args:</span>
<span class="sd">            split (str): name of the split to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitroot</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-holdout.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">))</span></div>

<div class="viewcode-block" id="Database.super_file"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.super_file">[docs]</a>    <span class="k">def</span> <span class="nf">super_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the full path to the h5 database file that can be</span>
<span class="sd">        used to *super* validate the potential fit.</span>

<span class="sd">        Args:</span>
<span class="sd">            split (str): name of the split to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitroot</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-super.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">))</span></div>

<div class="viewcode-block" id="Database.split"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Splits the database multiple times, one for each `split` setting in</span>
<span class="sd">        the database specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subconfs</span> <span class="o">=</span> <span class="n">AtomsList</span><span class="p">()</span>
        <span class="n">nonsplit</span> <span class="o">=</span> <span class="n">AtomsList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isteps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">trainable</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ekey</span><span class="p">,</span> <span class="n">fkey</span><span class="p">,</span> <span class="n">vkey</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">,</span> <span class="s2">&quot;virial&quot;</span><span class="p">]]</span>
            <span class="n">hesskey</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hessian&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atconf</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">fitting_configs</span><span class="p">:</span>
                <span class="n">ati</span> <span class="o">=</span> <span class="n">_conform_atoms</span><span class="p">(</span><span class="n">atconf</span><span class="p">,</span> <span class="n">ekey</span><span class="p">,</span> <span class="n">fkey</span><span class="p">,</span> <span class="n">vkey</span><span class="p">,</span> <span class="n">hesskey</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">splittable</span><span class="p">:</span>
                    <span class="n">subconfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ati</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nonsplit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ati</span><span class="p">)</span>

        <span class="n">file_targets</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_file</span><span class="p">,</span> <span class="s2">&quot;holdout&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">holdout_file</span><span class="p">,</span>
                        <span class="s2">&quot;super&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">super_file</span><span class="p">}</span>
        <span class="n">split</span><span class="p">(</span><span class="n">subconfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">,</span> <span class="n">file_targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitroot</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ran_seed</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="n">recalc</span><span class="p">,</span> <span class="n">nonsplit</span><span class="o">=</span><span class="n">nonsplit</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Database.extract"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">asis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the extract methods of each database in the collection, in the</span>
<span class="sd">        correct order.</span>

<span class="sd">        Args:</span>
<span class="sd">            cleanup (str): the level of cleanup to perform after extraction.</span>
<span class="sd">            asis (bool): when True, read the results even if the calculation</span>
<span class="sd">              didn&#39;t converge to required accuracy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isteps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">,</span> <span class="n">asis</span><span class="o">=</span><span class="n">asis</span><span class="p">):</span>
                <span class="n">imsg</span> <span class="o">=</span> <span class="s2">&quot;Group </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> is not ready yet. Done.&quot;</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">imsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dbname</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">blank</span><span class="p">()</span></div>

<div class="viewcode-block" id="Database.setup"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up the database collection by generating the POTCAR file and</span>
<span class="sd">        initializing any databases that haven&#39;t already been initialized.</span>

<span class="sd">        .. note:: The db setup functions are setup to only execute once, and then only if their dependencies have completed their calculations. This method can, therefore, be safely called repeatedly between different terminal sessions.</span>

<span class="sd">        Args:</span>
<span class="sd">            rerun (int): when &gt; 0, recreate the folders even if they</span>
<span class="sd">              already exist. Higher levels redo more of the work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isteps</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up database </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dbname</span><span class="p">))</span>
            <span class="n">db</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">rerun</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">blank</span><span class="p">()</span></div>

<div class="viewcode-block" id="Database.to_dict"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of the database parameters and settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from matdb.utility import __version__</span>
        <span class="c1"># from os import sys</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span><span class="n">__version__</span><span class="p">,</span><span class="s2">&quot;python_version&quot;</span><span class="p">:</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;root&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;steps&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">,</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Database.finalize"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Database.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalizes the database to a dictionary that can be saved to an h5 file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matdb.atoms</span> <span class="k">import</span> <span class="n">_recursively_convert_units</span>

        <span class="n">final_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">RecycleBin</span><span class="p">):</span>
            <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_db</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isteps</span><span class="p">:</span>
                <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;dbname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">train_perc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;splits&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">*-ids.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))):</span>
                    <span class="n">id_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                    <span class="n">final_dict</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_recursively_convert_units</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">id_file</span><span class="p">),</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_bin</span><span class="p">()</span>

        <span class="c1"># for name, trani_perc in self.splits.items():</span>
        <span class="c1">#     for f in glob(path.join(self.root,&quot;splits&quot;,self.name,&quot;{0}*-ids.pkl&quot;.format(name))):</span>
        <span class="c1">#         id_file = open(f,&#39;r&#39;)</span>
        <span class="c1">#         final_dict[f.split(&quot;.pkl&quot;)[0]] = _recursively_convert_units(pickle.load(id_file))</span>

        <span class="k">return</span> <span class="n">final_dict</span></div></div>


<div class="viewcode-block" id="RecycleBin"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin">[docs]</a><span class="k">class</span> <span class="nc">RecycleBin</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A database of past calculations to be stored for later use.</span>

<span class="sd">    Args:</span>
<span class="sd">        parent (Controller): instance controlling multiple configurations.</span>
<span class="sd">        root (str): root directory in which the &#39;RecycleBin&#39; folder will</span>
<span class="sd">          be placed.</span>
<span class="sd">        splits (dict): keys are split names; values are `float` *training*</span>
<span class="sd">          percentages to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">splits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up the RecycleBin database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;RecycleBin&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">splits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">splits</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">mkdir</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rec_bin&quot;</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">uuids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

<div class="viewcode-block" id="RecycleBin.to_dict"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all the atoms object files in the RecycleBin.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
        <span class="k">return</span> <span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;*.h5&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="RecycleBin.hash_bin"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.hash_bin">[docs]</a>    <span class="k">def</span> <span class="nf">hash_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a hash of the atoms objcets in the recycle bin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">convert_dict_to_str</span>

        <span class="n">hash_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rset</span><span class="p">:</span>
            <span class="n">temp_atom</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="n">hash_str</span> <span class="o">+=</span> <span class="n">convert_dict_to_str</span><span class="p">(</span><span class="n">temp_atom</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sha1</span><span class="p">(</span><span class="n">hash_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>

<div class="viewcode-block" id="RecycleBin.setup"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RecycleBin.extract"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="RecycleBin.recover"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.recover">[docs]</a>    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RecycleBin.split"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Splits the total available data in the recycle bin.</span>

<span class="sd">        Args:</span>
<span class="sd">            recalc (int): when non-zero, re-split the data and overwrite any</span>
<span class="sd">              existing *.h5 files. This parameter decreases as</span>
<span class="sd">              rewrites proceed down the stack. To re-calculate</span>
<span class="sd">              lower-level h5 files, increase this value.</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database sequence*</span>
<span class="sd">              names. This limits which databases sequences are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">chdir</span>

        <span class="k">with</span> <span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RecycleBin</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="n">recalc</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="n">dfilter</span><span class="p">)</span></div>

<div class="viewcode-block" id="RecycleBin.status"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">busy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;Prints a status message for each of the databases relative</span>
<span class="sd">        to VASP execution status.</span>
<span class="sd">        Args:</span>
<span class="sd">            busy (bool): when True, print a list of the configurations that are</span>
<span class="sd">              still busy being computed in DFT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s2">&quot;Ready&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RecycleBin.execute"><a class="viewcode-back" href="../../database/utility.html#matdb.database.RecycleBin.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div></div>

<div class="viewcode-block" id="Controller"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller">[docs]</a><span class="k">class</span> <span class="nc">Controller</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements methods for tying a configuration dictionary (in</span>
<span class="sd">    YAML format) to instances of various databases.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (str): name of the YML file (without the .yml) that</span>
<span class="sd">          specifies all information for constructing the set of databases.</span>
<span class="sd">        tmpdir (str): path to a temporary directory to use for the</span>
<span class="sd">          database. This is for unit testing purposes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        specs (dict): the parsed settings from the YAML configuration file.</span>
<span class="sd">        collections (dict): keys are configuration names listed in attribute</span>
<span class="sd">          `configs` of the YAML file. Values are the :class:`DatabaseCollection`</span>
<span class="sd">          instances.</span>
<span class="sd">        legacy (dict): keys are legacy database names; values are</span>
<span class="sd">          :class:`~matdb.database.legacy.LegacyDatabase`.</span>
<span class="sd">        plotdir (str): path to the directory to store plots in for all</span>
<span class="sd">          databases.</span>
<span class="sd">        venv (str): name of a virtual environment to activate for plotting</span>
<span class="sd">          potentials after fitting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tmpdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">relpath</span><span class="p">,</span> <span class="n">check_deps</span>
        <span class="kn">from</span> <span class="nn">matdb.calculators.utility</span> <span class="k">import</span> <span class="n">set_paths</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">versions</span> <span class="o">=</span> <span class="n">check_deps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">),</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specs</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="c1">#We allow the user to specify paths relative the matdb repo.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">relpath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">tmpdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">tmpdir</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;NAME&quot;</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>        
        <span class="n">_set_config_paths</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="n">set_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shell_command</span> <span class="o">=</span> <span class="s2">&quot;sbatch&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotdir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;plots&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpathdir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;kpaths&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="s2">&quot;shell_command&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;shell_command&quot;</span><span class="p">]</span>

        <span class="kn">import</span> <span class="nn">random</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;random_seed&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ran_seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calculator&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">venv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;venv&quot;</span><span class="p">)</span>

        <span class="c1"># We need to split out the databases by user-given name to create</span>
        <span class="c1"># the sequences.</span>
        <span class="kn">from</span> <span class="nn">matdb.database.legacy</span> <span class="k">import</span> <span class="n">LegacyDatabase</span>
        <span class="k">for</span> <span class="n">dbspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;databases&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">dbspec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;legacy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">cpspec</span> <span class="o">=</span> <span class="n">dbspec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
                <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;splits&quot;</span><span class="p">)</span>
                <span class="c1">#We allow the user to specify the folder relative to repository</span>
                <span class="c1">#root; this is mainly for unit tests.</span>
                <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relpath</span><span class="p">(</span><span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;legacy&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">[</span><span class="n">cpspec</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">LegacyDatabase</span><span class="p">(</span><span class="o">**</span><span class="n">cpspec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbname</span> <span class="o">=</span> <span class="n">dbspec</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">dbspec</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
                <span class="c1">#We use the global random seed by default if one isn&#39;t specified</span>
                <span class="c1">#explicitly for the database.</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                              <span class="n">steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;splits&quot;</span><span class="p">),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;random_seed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ran_seed</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span>

        <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">mkdir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotdir</span><span class="p">):</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpathdir</span><span class="p">):</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpathdir</span><span class="p">)</span>

        <span class="c1">#If the controller is going to train any potentials, we also need to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;fitting&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">matdb.fitting.controller</span> <span class="k">import</span> <span class="n">TController</span>
            <span class="n">tdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;fitting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">tdict</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
            <span class="n">tdict</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainers</span> <span class="o">=</span> <span class="n">TController</span><span class="p">(</span><span class="o">**</span><span class="n">tdict</span><span class="p">)</span>

<div class="viewcode-block" id="Controller.ifiltered"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.ifiltered">[docs]</a>    <span class="k">def</span> <span class="nf">ifiltered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a *filtered* generator over databases in the collections of this object.</span>

<span class="sd">        Args:</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">fnmatch</span> <span class="k">import</span> <span class="n">fnmatch</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dfilter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dfilter</span><span class="p">):</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dbi</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.relpaths"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.relpaths">[docs]</a>    <span class="k">def</span> <span class="nf">relpaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the relative paths for the seed configurations within the databases that</span>
<span class="sd">        match to the pattern.</span>

<span class="sd">        Args:</span>
<span class="sd">            pattern (str): the pattern to match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matdb.database.utility</span> <span class="k">import</span> <span class="n">parse_path</span>
        <span class="k">return</span> <span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">pattern</span><span class="p">,</span><span class="n">ran_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ran_seed</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.find"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds a list of :class:`~matdb.database.Group` that match the given</span>
<span class="sd">        pattern. The pattern is formed using `group.dbname[[.seed].params]`. `*`</span>
<span class="sd">        can be used as a wildcard for any portion of the &#39;.&#39;-separated path.</span>

<span class="sd">        .. note:: Actually, an :func:`~fnmatch.fnmatch` pattern can be used.</span>

<span class="sd">        Args: </span>
<span class="sd">            pattern (str): fnmatch pattern that follows the convention of the DB key. Alternatively the pattern can be a uuid. </span>

<span class="sd">        Examples:</span>

<span class="sd">            Get all the dynamical matrix databases for the `Pd`</span>
<span class="sd">            configuration. The example assumes that the database name is</span>
<span class="sd">            `phonon` and that it includes a dynamical matrix step.</span>

<span class="sd">                &gt;&gt;&gt; Pd = Controller(&quot;Pd.yml&quot;)</span>
<span class="sd">                &gt;&gt;&gt; Pd.find(&quot;DynMatrix.phonon.Pd.*&quot;)</span>

<span class="sd">            Get all the database sequences for liquids across all configurations in</span>
<span class="sd">            the database.</span>

<span class="sd">                &gt;&gt;&gt; CdWO4 = Controller(&quot;CdWO4.yml&quot;)</span>
<span class="sd">                &gt;&gt;&gt; CdWO4.find(&quot;*.liquid*&quot;)</span>
<span class="sd">                &gt;&gt;&gt; CdWO4.find(uuid)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matdb.utility</span> <span class="k">import</span> <span class="n">is_uuid4</span>
        <span class="k">if</span> <span class="n">is_uuid4</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuids</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>

        <span class="kn">from</span> <span class="nn">fnmatch</span> <span class="k">import</span> <span class="n">fnmatch</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">groupname</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">groupname</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">groupname</span><span class="p">,</span> <span class="n">dbname</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#We must be searching legacy databases or the pattern given is to</span>
            <span class="c1">#match a *database* and not a group.</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">pattern</span>
            <span class="n">groupname</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">colls</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dbname</span><span class="p">)]</span>
        <span class="n">colls</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">li</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="n">colls</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbi</span><span class="p">,</span> <span class="n">LegacyDatabase</span><span class="p">)</span> <span class="ow">or</span> <span class="n">groupname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dbi</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupi</span> <span class="k">for</span> <span class="n">groupn</span><span class="p">,</span> <span class="n">groupi</span> <span class="ow">in</span> <span class="n">dbi</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                      <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">groupn</span><span class="p">,</span> <span class="n">groupname</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="n">si</span> <span class="k">for</span> <span class="n">sn</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">seed</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">seedi</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>

                        <span class="n">seedi</span><span class="o">.</span><span class="n">_expand_sequence</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seedi</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">si</span> <span class="k">for</span> <span class="n">sn</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">seedi</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                           <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">params</span><span class="p">)])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seedi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">groupname</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="c1">#Add all the possible legacy databases.</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">li</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">groupname</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Controller.steps"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.steps">[docs]</a>    <span class="k">def</span> <span class="nf">steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compiles a list of all steps in this set of databases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">seed_name</span><span class="p">,</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">seed</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{2}</span><span class="s2">/</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span><span class="n">db_name</span><span class="p">,</span>
                                                                           <span class="n">seed_name</span><span class="p">,</span><span class="n">param_name</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span><span class="n">db_name</span><span class="p">,</span>
                                                                   <span class="n">seed_name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span><span class="n">db_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.sequences"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.sequences">[docs]</a>    <span class="k">def</span> <span class="nf">sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compiles a list of all sequences in this set of databases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">seed_name</span><span class="p">,</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">seed</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed_name</span><span class="p">,</span><span class="n">param_name</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the database object associated with the given key. This is</span>
<span class="sd">        necessary because of the hierarchy of objects needed to implement</span>
<span class="sd">        sequence repitition via the `ParamaterGrid`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">dbname</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">coll</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">seed</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">seq</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">params</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">seq</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">step</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">err</span><span class="p">(</span><span class="s2">&quot;The group name </span><span class="si">{0}</span><span class="s2"> could not be found in the steps of &quot;</span>
                    <span class="s2">&quot;the database </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">coll</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

<div class="viewcode-block" id="Controller.setup"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up each of configuration&#39;s databases.</span>

<span class="sd">        Args:</span>
<span class="sd">            rerun (int): when &gt; 0, recreate the folders even if they</span>
<span class="sd">              already exist.</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases sequences are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
                <span class="n">dbi</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">rerun</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Save the paths to the setup atoms objects for the Tracy</span>
            <span class="c1"># extract method.</span>
            <span class="n">uuid_paths</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">matdb_id</span><span class="p">,</span> <span class="n">matdb_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matdb_obj</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">):</span>
                    <span class="n">uuid_paths</span><span class="p">[</span><span class="n">matdb_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">matdb_obj</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">folder</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;atoms_paths.json&quot;</span><span class="p">),</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">uuid_paths</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;user_cred.json&quot;</span><span class="p">)):</span> <span class="c1">#pragma: no cover</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;user_cred.json&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Controller.extract"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">asis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs extract on each of the configuration&#39;s databases.</span>

<span class="sd">        Args:</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases are returned.</span>
<span class="sd">            cleanup (str): the level of cleanup to perform after extraction.</span>
<span class="sd">            asis (bool): when True, read the results even if the calculation</span>
<span class="sd">              didn&#39;t converge to required accuracy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s2">&quot;Extracting calculation output from </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">dbi</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">,</span> <span class="n">asis</span><span class="o">=</span><span class="n">asis</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.execute"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submits job array scripts for each database collection.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (bool): when True, submit the script for running recovery</span>
<span class="sd">              jobs.</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases are returned.</span>
<span class="sd">            env_vars (dict): dict of environment variables to set before calling the</span>
<span class="sd">              execution. The variables will be set back after execution.</span>
<span class="sd">            dryrun (bool): when True, don&#39;t submit any jobs for execution, just</span>
<span class="sd">              say what would happen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
            <span class="n">dbi</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">env_vars</span><span class="o">=</span><span class="n">env_vars</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.recover"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.recover">[docs]</a>    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs recovery on this database to determine which configs failed and</span>
<span class="sd">        then create a jobfile to requeue them for compute.</span>

<span class="sd">        Args:</span>
<span class="sd">            rerun (bool): when True, recreate the jobfile even if it already exists.</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database* names. This limits which databases are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
            <span class="n">dbi</span><span class="o">.</span><span class="n">recover</span><span class="p">(</span><span class="n">rerun</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.status"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">busy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints status messages for each of the configuration&#39;s databases.</span>

<span class="sd">        Args:</span>
<span class="sd">            busy (bool): when True, print a list of the configurations that are</span>
<span class="sd">              still busy being computed in DFT.</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases are returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
            <span class="n">dbi</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.split"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Splits the total available data in all databases into a training and holdout</span>
<span class="sd">        set.</span>

<span class="sd">        Args:</span>
<span class="sd">            recalc (int): when non-zero, re-split the data and overwrite any existing *.h5 files. This parameter decreases as rewrites proceed down the stack. To re-calculate lower-level h5 files, increase this value.</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database sequence* names. This limits which databases sequences are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">dbi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
            <span class="n">dbi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">recalc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.hash_dbs"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.hash_dbs">[docs]</a>    <span class="k">def</span> <span class="nf">hash_dbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hashes the databases into a single hash.</span>

<span class="sd">        Args:</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hash_all</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
            <span class="n">hash_all</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
            <span class="n">hash_all</span> <span class="o">+=</span> <span class="n">seq</span><span class="o">.</span><span class="n">hash_db</span><span class="p">()</span>

        <span class="n">hash_all</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
        <span class="n">hash_all</span> <span class="o">+=</span> <span class="n">seq</span><span class="o">.</span><span class="n">rec_bin</span><span class="o">.</span><span class="n">hash_bin</span><span class="p">()</span>

        <span class="n">hash_all</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sha1</span><span class="p">(</span><span class="n">hash_all</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;hash.txt&quot;</span><span class="p">),</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hash_all</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())))</span>

        <span class="k">return</span> <span class="n">hash_all</span></div>

<div class="viewcode-block" id="Controller.verify_hash"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.verify_hash">[docs]</a>    <span class="k">def</span> <span class="nf">verify_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hash_cand</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that the the candidate hash matches this matdb controller&#39;s databases.</span>

<span class="sd">        Args:</span>
<span class="sd">            hash_cand (str): The candidate hash to check.</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases are returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the hash matches the databases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hash_cand</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_dbs</span><span class="p">(</span><span class="n">dfilter</span><span class="o">=</span><span class="n">dfilter</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.finalize"><a class="viewcode-back" href="../../database/utility.html#matdb.database.Controller.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the finalized version of the databases that were used for</span>
<span class="sd">        fitting the potential. Stored in final_{matdb.version}.h5.</span>

<span class="sd">        Args:</span>
<span class="sd">            dfilter (list): list of `str` patterns to match against *database*</span>
<span class="sd">              names. This limits which databases are returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># from matdb.io import save_dict_to_h5</span>
        <span class="c1"># from matdb import __version__</span>

        <span class="n">final_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_dbs</span><span class="p">(</span><span class="n">dfilter</span><span class="o">=</span><span class="n">dfilter</span><span class="p">)</span>
        <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;yml_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifiltered</span><span class="p">(</span><span class="n">dfilter</span><span class="p">):</span>
            <span class="n">final_dict</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dfilter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;rec_bin&quot;</span> <span class="ow">in</span> <span class="n">dfilter</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dfilter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dfilter</span><span class="o">==</span><span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">final_dict</span><span class="p">[</span><span class="s2">&quot;rec_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">rec_bin</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="n">str_ver</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">__version__</span><span class="p">:</span>
            <span class="n">str_ver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="n">mdb_ver</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_ver</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s2">&quot;final_</span><span class="si">{}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mdb_ver</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="n">save_dict_to_h5</span><span class="p">(</span><span class="n">hf</span><span class="p">,</span><span class="n">final_dict</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">matdb 0.0.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Conrad W. Rosenbrock.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>